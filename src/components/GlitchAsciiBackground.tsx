import {
  useState,
  useEffect,
  useRef,
  useCallback,
} from "react";

interface MousePosition {
  x: number;
  y: number;
}

export function GlitchAsciiBackground() {
  const [mousePos, setMousePos] = useState<MousePosition>({
    x: 0,
    y: 0,
  });
  const [isHovering, setIsHovering] = useState(false);
  const [isMouseMoving, setIsMouseMoving] = useState(false);
  const [showText, setShowText] = useState(false);
  const [glitchedPattern, setGlitchedPattern] = useState("");
  const mouseMoveTimeoutRef = useRef<NodeJS.Timeout>();
  const rafRef = useRef<number>();

  const basePattern = `::::.......:...........:..............................:..............::::::::.................:.:.......................................::::::.:::::::::::::::::::::::::::::::::::::::::--:::::::--:::::::::::::::-
::::.............................................:.......................:::::::........................................................:..............::::::::::::::::::::::::::::::::::::::::::::::::::::::::----
:::::...........................:.:........................................::::::::................:................:.............................:..:::::::::::::::::::::::::::::::::::::::::::::::::::::::::--::-
..:::::.............................................:........................:::::::.............................................................:.::::::::::::::::::::::::::::::::::::::::::::::::::::::::--::::::
....................................................................:...........::::::...::::.............:................................::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
...........................................:................:.......................:::::::.......:...:.............................:.....:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
.............:..................................................:.....................:..............:..........::........................:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
........................................:...........................................................:+%*:............:.....................::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
............:.................................:....................:...............................::-=##+:..............................:.....:::::::::.:.............::::::::::::::::..:.::::::::::::::::::::::::
...................................................................................................::-=*#%%-..................................................................................:::::::::::::::::::::
...............:.....................................................:.............................::-=+*%@@*:::::::::::::...::::::::::::::::::::::::::::::::::::...::::::::::.::::............::::::::::::::::::::
.:.................................................................................................::--=++#%@@*::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
...................:............................................:.................................:::--==++*#@@*:::::::::::::::::::::::::::::::::::..:::::::............:::::::::::::::::::::::::::::::::::::::::::
...............:......:..........................................................................::::---==++**##%=::::::::::.............::::::.....................................:::::::::::::::::::::::::::::::
...................::...............:..........................................................::::::---=++++**#@@*:::.....:.......................................................:::----:::::::::::::::::::::::::
.......:...:.......::.:::::.::::::::::::::..::.:..............................................:::---:===++++****@@@*.......::...................:.......................:...:....::::--------------------------::::
......................::::::::::::::::::....::...............................................::------==++==+*+**%@@@@:.......::.......:.........:..............................::::::-----===----------------------
..............................:::.::::......:::.....:.......................................:-===-=====++=++****#@@@@@:...:::::::.............................................::::::::--------=----------::--------
:..............................................................:...........................:-+=========+==+******#@@@@%...:::::::::..............................:..........:::::::::::----::----------::.::-------
......................:..............................................................:.:::====+-======++=++*+**++++%@@%....::::::::::.......................:......:.....:.::::::::::-::----::::------:.....:::::::
....................................:........::..:................................:--=+::+++++=========++++++**++++#@@@+.....:::::::::.........................:..........::::::::::--------:::::-----:.....::::...
.........:..:..................::.::::::::::::...........:......................:==-::::=*+++=---========+++++*++++**%@%-......:::..::..:.......................:...::...:::::::::::-----------::------:..:::::::::
......:.::.::....................:::::::::::::.....................:::::...:...-+=:-:::=+=++++--=======+=++++++++++***%%+:..:....::::.................................::::::::::::::------------::----=------------
..............................:::.......::::::::::::...............:...........==-....::+=+=-:-=+========++++++++*****+*%@@@@%=:.......::::.............................::::::::::::--------=====--=====----=======
................................:......:...:::::::::::.......................:==---::--+++===--=======++++++++=++*++++++*%@@@@@#-:....:::::.......................:.......::::::::::-------========================
:...............................:...........:...............:................-----:-=-:=+--=--:=======++++=+++++++++=*++**@@@@@@%*-:.:::::.................................::::::::---------==-====================
.................................................................:......:...---:::===--==-==-:=+======++++==++==++==*+=*#+%@@@@@@@%#+-::::................................:::::::::-----------=========+++===+=+==+
........................................................................:..:------==-===-=+=++++=-=++++++==+++++++=-*==**+*@@@@@@@@@##*=::...............:................::::::::-----------==========+++++++++==+
......::..........................................................:........-:.::-=--:=++======+=-==+==+++++++++=--:=+=+*==+%%@@@@@@@@@%##*=:.....:.......................::::::::::--------========================
.....................................:....:........:..........................:==-=:-====----==---===+++++++=+==-::+:-+=--=*%@@@@@@@@@@@%%%#*=:.:......................:::::::::::::----------------===============
...............:.................................:.......................::..:-=:=:-==+==+=--=----==+++++=+++++=--+=-==--=-+%@@@@@@@@@@@@@%#%%%%=.....................:.:::::::::::::--::::::::...:::----::::------
......................................................................:..:-.:-:.:.:-======-:--.:---=**++++++*+=--==--==-+==#@@@@@@@%%%@@@@@%##%%%%+......................:::::::::::::--:::::::::.:::::-::::::---::
..................................................................:::::::...:.....-:----=-:-=-.-=--+**++*#**++*=--=++*+++*%%**@@@@@@%%%%%%%@%%%%%%%%+.....................::::::::::::------------------:::::::::::
::::::...........:.....................:.........................+-:.:=:..:=::..--:.:=++++++==+*++**++=+++======-=+####+=*##***%@%@@@%############%%%%+....................::::::::::----------------------::------
:::::::::....................:.....:............................-=-:.::..--:.....-==*##*+******##*#*=----::::=++=+**=-==+***++*#%%@@@@@#############%%%#=..................:::::::::::----------------===---------=
:::::::::....................................................:-=:::.....--:...---=#%@@@#+******#*+-..:...:::=+++++++++===+=:.:==-+#%%@@@%##########%#%##%#=................:::::::::::--------------=============++
-::::::::..::::--::...................:.............::::...::---=+.........:-+*#%%%%%%%%%###****:......:::==+++++++++=::.:.......-#%#####%#####%%#########%#:.........:::::::::::::::::------------==========+++***
++*+++=+*#%%%##%%#%@*-...................:::::::::::-+*+=:..:::--::-=+++==+*######%##%%%%*===:....:--:::==+++++++++++++=-:......-*##*++**#########%%%%%%%%%%#*-::....::::::::::::::::::-----------========+++++****
@#**#%@%####*###%%@@%%%%#+=::::::..::::::::::----=+*****##*=------==+++++*+***++*#####*+--:.....=+++=-:+**#***++++===+==-.::.::..:...:+#**#####**##%%%%#%%%%###*+::::::::::::::::::::::-----------======+++++**####
##**###%@%##%###%%@@@@#%@@@@%@%+=====++=-++******+++++++++++++=========+++++++++++*+==--:......-===++==##*****++=======-..........:..:-*######*****###%%%%#######**=::::::::::::::::::------------=====++++**#####*
##***##@@@%%#*###%%@@@@@@@@@@@@@@#++++++**+**+++++=++++++++++++==++======+++=+++===-::........::-====-::::---:::-----...................+#*#%###########%#%%%#######*=-:::::::::::::::::::---------=====+***#####*#
%@%%#***%@@%%%##@%##%@@@@@@@@@@@@@@@*++++++++++++=:=++++*++*++****+++==========--:........:::-=++++++-.::::::.............::+**-........=#%##%##%%%%%%%%%#%#%%%@%%#####-::.::-:::::::::::::::--------=++*****###*##
@@@@%#*##%@%%#%%%@@@###%%%%%%@@@@@@@@%%#*++++++++*%%%*+++++*+++++*#*+++===++*++*++++++++=::--=++++++++**==+=......:.......-=-:........:=+*%@##%%%######%%%@%#%%%%%%#*####=:::::::::::::::::::---------=+****#####%#
%@@@@@@%#%@@@@@@@@@@@@%#%%%%@@@@@@@@@@@@@#*++***#%%%@@@@%##**++*+++++++++*+++*****++++=----::::=++++++=-................:............-=++*+*####%@%%%%#%%%%#%#%########**###*=:.........::::::--------=====+*####%%
@@@@@@@%##%@@@@@@@@@@%@@@%@@@%@@@@@@@@@@@#***#%%%%#*####%@%***++*%#**####*****+*++++++++*==-:=++++++-:..........................:..-====++++-=*##%%###%#####%%#%%%#############*-:---:...=##=::::::-----======*#%%%
@@@@@@@@@@@%#%%#%%@@@%%@@@%##%%@@@@@@@@@@%*****#%@@%#*##########*******####**++++++**++**++***+++=--:.........:-::-:....-*+++==+***++++*##***+=+#**######%#####%%#%%%%%%%%#######**+:..-+*####=:....::-===+++**#%%@
#####%@@%%#####%%@@@@@@%@@%%%%%%%@%%%%%@@@@@@@%##%@@@@%%@@@%%%%@@@%#************####*##*****#******+==-..::...--:..:=****++++******+*###*+=-+*+**#########%%%#########%%%%%%%%%%%#**+=#%%##*+++*******++**+*****##%
#*****#############%%###############%#%@@@@@@@@@@%#%@@@@@@@@@@@@@%%%%%##%#####%%%%%%%%@%#%%%#%@%%%#*##=-:...:-::-=+=+**++++++--=*#*####***#*##**%%#%%##**#######%####%#%%%%%###%###*#####*##%##***#%%@###***##****#
=++**************######################%%@@%###%@@@%#%%%@@@%%%%%%@@@%#************##%%#######%%####***+-...........:.:-........:+###%**##+==-::=-+##%#*+**+*****##**####%%#####%###########%@%%@@@@@@@%%#**#######*
-------=+===+***************************#********###****######*####*********++******##%@%*#***********#=.........::.....--....=****+++=:.....-=+=**++#%%*%##***%#%%##+==++*+*****######*****#*#@@@@@@@@@@%*******##
.....::::::...::-++++************************************++*****+++**+****+++*************#@@%*+*#***=:-:-=*#%%##*+*+###*#=-*@@%%##*+-.:.:=..-*#%++%%####%%#+*###%%%%##*+==-:++++*#%%#******##**#%%#%##@@@%#*******
++=::::..................:::--==+++++**************++++++===+++++++******#*************+++***++******@@#=+*#*#*=-*#%###+=-:*@%%%#**+:--==-=-:=+*=.-=-:-+%%#**==++*#*=+*+=-.:---:-+*#*=++++**#***####**#%#####%@%%%#
@%%@%%%%#+=-::::::...:....:...-=+=:..::::::==++***+==#%@@@##+++++++++++===+++++++**************++==++++===+*#+++#%%#+*%**##%###=:.:.....:-:.....-==+===+*+::====--..-=-:.:......=++==++==+==+#%%%@%@@@%%%#######%@@
@@@@@%@@@@@@@%#**=-:..:::..:-****++**#@@%#%%@@@@@@%%@@%%%@@@%%%%#-:=++**+---:-=====++---+*#%#***++===-:-=+*=::===+=.....:-.......................:....:::::::-....:::....:........::-=*###%@%%%%#%@@%%%@%%#########
%%%@%@@@@@@@@@%@@@@@*-::-+#%@@@@@@@@@@@@@@@@@@@@@%%%%%%#***+====-::+#***+:-==+***+=*#%##%%%%%%%%%#*+++++=====--==-:.:.................:...............:....................:..........-=++#*++**++**##%@@%%%#######
@@@@@@@@@@@@@%%%%%%%%%%#*++++=-=+*##%@@@@@%%%##*+-::::.......:-=+***##*#%#*=:=*#%%%%%##**##**#%%%%@%*=+******#@@@@@@%%#**+=+*###***#***+:.....:.....................................:-..:-===--==--=+*#%@@#%@@@%###
@@@@@@@@@@@@@@%@@@@@@@@%%####+:.................:-:..:-=+====+****#%%%****#%#**++####*##=-====-=+**#%@@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=......................:...-:-....................:.....::-=+++###%@%%%%
**+#%@@@@@@@@@@@@@@@@%%@@@@@%@%%%###*+*#*++==-::---:-==+*#%%%%%@%%%%%%@%#%%%%%%%%###*#**=....-+#%######**###%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%=.................:=....:-=##+=:.....::.-:...:---:+*++==+**##*##%%%%%
*+++*#%%@@@@@@@@@@@@@@@@@@@@@@@%%%%@@%@@@%%%%%%#+-::+*+=====+*##%%%%@@@@%%%%%#*+=::-:---+=++**%%%%%%%%#*=--=++=+#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*.....:::-:....=-.::..-++**==+##***-:-::::=--:..:.=*##*#####%%%%%%%
@@@%#++*#++*#@#@%@@@@@@@@@@@@@@@@@@@@%%%%@@@@@@%%%%%%%%%%%%%##**+++++*%@@@@@@@%%%%@@@*-..-+*#%%%%%%%%%%%%%#+=--#%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@#*=-:........:=-...:=##*=-:.:-*###-..:=-+--%+------*###%%%%##%%##
%%%%%@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@@%%@@%%%%%%%%%%%%%#===+*#%#*+*#%@@%@%%%%%%%*=-=*##+-::-++=-=+*#@@%%%%%%%%%%#%%%%%@@@@@@@@@@@@@@@@@@@@@@#*-.........--..-#=+-::::::::+#%+..+*-:......::--+**###%###%##
@@@@@@%%%@@@%%%#%%%@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%#%%#####*%%%%%%@@%%#%%@@@@%%*-:......:--+*##**#%%%###%%%@@%%%@%%%%%@@@@@@@@@@@@@@@@@@@%-.............:....::.:::..:.:++.-+*=-.::*##*=::-=**--+#%%%#%
@@@@@@@@@@@@@@@@@@@@%%####%%%%@@@@@@@@@@@@@@@@@@@@@@@@@%%##%@%%%%%%%@%%%%%%%%%%@%%%%%%%%%#####*-........::=*###***##%%%%%%%%%%%%%@%%%%%@@@@@@@@@@@@@%+:.................+-...:.....:#*---:.....:==---**##%#*++*%%%@
++*#%@%@%%@%%@@@@@@@@%%@@@@%%%#***+****#%@@@@@@@@@@@@@@@@@@@@@@%%%%%@@%%%%%%%%%%%@@@%%%%%%%%%%%%###+=---:::::-=+*#%%%%%%%%%%%%%%%@@@@%%%@@@@@@@@@@%%#:...................:--::...-++*+:=+:.::..:--+*==+*+=++=#@%#%%`;

  const glitchCharsArray = [
    "▲",
    "▼",
    "◦",
    "●",
    "◆",
    "◊",
    "■",
    "□",
    "▪",
    "▫",
    "◢",
    "◣",
    "◤",
    "◥",
    "░",
    "▒",
    "▓",
    "█",
    "╬",
    "╪",
    "┼",
    "┿",
    "╄",
    "╃",
    "╅",
    "╆",
    ":",
    "-",
    "=",
    "+",
    "*",
    "#",
    "%",
  ];

  // Initialize glitched pattern
  useEffect(() => {
    setGlitchedPattern(basePattern);
  }, []);

  // Optimized mouse move handler
  const handleMouseMove = useCallback((e: MouseEvent) => {
    const heroSection = document.querySelector(".hero-section");
    if (!heroSection) return;

    if (rafRef.current) {
      cancelAnimationFrame(rafRef.current);
    }

    rafRef.current = requestAnimationFrame(() => {
      const rect = heroSection.getBoundingClientRect();
      const newX = e.clientX - rect.left;
      const newY = e.clientY - rect.top;
      
      // Only update if position changed significantly (reduces unnecessary renders)
      setMousePos(prev => {
        if (Math.abs(prev.x - newX) > 2 || Math.abs(prev.y - newY) > 2) {
          return { x: newX, y: newY };
        }
        return prev;
      });
    });

    setIsMouseMoving(true);
    setShowText(false);

    // Clear existing timeout
    if (mouseMoveTimeoutRef.current) {
      clearTimeout(mouseMoveTimeoutRef.current);
    }

    // Set new timeout for 1 second after mouse stops
    mouseMoveTimeoutRef.current = setTimeout(() => {
      setIsMouseMoving(false);
      setShowText(true);
    }, 1000);
  }, []);

  // Handle mouse movement detection
  useEffect(() => {
    const heroSection = document.querySelector(".hero-section");
    if (!heroSection) return;

    const handleMouseEnter = () => setIsHovering(true);
    const handleMouseLeave = () => {
      setIsHovering(false);
      setIsMouseMoving(false);
      setShowText(false);
      if (mouseMoveTimeoutRef.current) {
        clearTimeout(mouseMoveTimeoutRef.current);
      }
      if (rafRef.current) {
        cancelAnimationFrame(rafRef.current);
      }
    };

    heroSection.addEventListener("mousemove", handleMouseMove);
    heroSection.addEventListener("mouseenter", handleMouseEnter);
    heroSection.addEventListener("mouseleave", handleMouseLeave);

    return () => {
      heroSection.removeEventListener("mousemove", handleMouseMove);
      heroSection.removeEventListener("mouseenter", handleMouseEnter);
      heroSection.removeEventListener("mouseleave", handleMouseLeave);
      if (mouseMoveTimeoutRef.current) {
        clearTimeout(mouseMoveTimeoutRef.current);
      }
      if (rafRef.current) {
        cancelAnimationFrame(rafRef.current);
      }
    };
  }, [handleMouseMove]);

  // Optimized glitch animation with throttling
  useEffect(() => {
    if (!isHovering) {
      setGlitchedPattern(basePattern);
      return;
    }

    if (!isMouseMoving) {
      // When mouse stops, clean up and show original pattern
      const resetTimeout = setTimeout(() => {
        setGlitchedPattern(basePattern);
      }, 100);
      return () => clearTimeout(resetTimeout);
    }

    let animationId: number;
    let lastUpdateTime = 0;
    const throttleMs = 50; // Limit updates to ~20fps for performance

    const updateGlitch = (currentTime: number) => {
      // Throttle updates for performance
      if (currentTime - lastUpdateTime < throttleMs) {
        animationId = requestAnimationFrame(updateGlitch);
        return;
      }
      
      lastUpdateTime = currentTime;

      const lines = basePattern.split("\n");

      // Precise character grid calculations for text-xs (12px) with leading-none
      const charWidth = 7.2; // Character width for Courier New 12px
      const lineHeight = 12; // Line height for text-xs with leading-none (12px * 1)

      // Mouse position is already relative to hero section
      const centerY = Math.round(mousePos.y / lineHeight);
      const centerX = Math.round(mousePos.x / charWidth);

      // Circle radius in characters - adjust for aspect ratio to make perfect circle
      const radiusX = Math.round(75 / charWidth); // ~10 characters horizontal
      const radiusY = Math.round(75 / lineHeight); // ~6 characters vertical with 12px line height

      // Only process lines within the glitch radius for performance
      const startLine = Math.max(0, centerY - radiusY - 1);
      const endLine = Math.min(lines.length - 1, centerY + radiusY + 1);

      const newLines = lines.map((line, lineIndex) => {
        // Skip processing lines outside glitch area
        if (lineIndex < startLine || lineIndex > endLine) return line;
        
        const lineDistance = Math.abs(lineIndex - centerY);
        if (lineDistance > radiusY) return line; // Keep original line if too far

        return line
          .split("")
          .map((char, charIndex) => {
            // Perfect circle calculation with aspect ratio correction
            const dx = (charIndex - centerX) / radiusX;
            const dy = (lineIndex - centerY) / radiusY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Only glitch characters exactly within the perfect circle
            if (distance <= 1 && Math.random() > 0.3) {
              return glitchCharsArray[
                Math.floor(Math.random() * glitchCharsArray.length)
              ];
            }
            return char; // Keep original character
          })
          .join("");
      });

      setGlitchedPattern(newLines.join("\n"));

      // Continue animation
      animationId = requestAnimationFrame(updateGlitch);
    };

    // Start animation immediately
    animationId = requestAnimationFrame(updateGlitch);

    return () => {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
    };
  }, [isHovering, isMouseMoving, mousePos.x, mousePos.y]);

  return (
    <div className="absolute inset-0 overflow-hidden pointer-events-none">
      {/* Base ASCII Pattern with potential glitch */}
      <div className="text-accent/20 text-xs font-mono leading-none whitespace-pre absolute top-0 left-0 w-full">
        {glitchedPattern}
      </div>

      {/* Circular Text Reveal Layer - appears when mouse stops */}
      {isHovering && showText && (
        <div
          className="absolute pointer-events-none z-10 will-change-transform"
          style={{
            transform: `translate3d(${mousePos.x - 100}px, ${mousePos.y - 100}px, 0)`,
            width: "200px",
            height: "200px",
            transition: "opacity 0.3s ease-in-out",
          }}
        >
          {/* Circular background mask to clear ASCII */}
          <div
            className="absolute inset-0 bg-background rounded-full border border-accent/20"
            style={{
              boxShadow: "0 0 30px rgba(74, 85, 104, 0.9)",
            }}
          ></div>

          {/* Text content centered within circle */}
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="text-center text-accent font-mono">
              <div className="text-sm leading-tight animate-pulse">
                FIRST
                <br />
                DECENTRALIZED
                <br />
                CHF
                <br />
                STABLE COIN
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}